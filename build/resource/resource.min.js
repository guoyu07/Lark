var __define=this.__define||function(e,t,i,r){Object.defineProperty(e,t,{configurable:!0,enumerable:!0,get:i,set:r})},RES;!function(e){var t=function(){function t(){this.keyMap={},this.groupDic={},e.configInstance=this}var i=t;return p=i.prototype,p.getGroupByName=function(e){var t=new Array;if(!this.groupDic[e])return t;for(var i=this.groupDic[e],r=i.length,s=0;r>s;s++){var n=i[s];t.push(this.parseResourceItem(n))}return t},p.getRawGroupByName=function(e){return this.groupDic[e]?this.groupDic[e]:[]},p.createGroup=function(e,t,i){if(void 0===i&&(i=!1),!i&&this.groupDic[e]||!t||0==t.length)return!1;for(var r=this.groupDic,s=[],n=t.length,a=0;n>a;a++){var o=t[a],u=r[o];if(u)for(var l=u.length,h=0;l>h;h++){var c=u[h];-1==s.indexOf(c)&&s.push(c)}else c=this.keyMap[o],c&&-1==s.indexOf(c)&&s.push(c)}return 0==s.length?!1:(this.groupDic[e]=s,!0)},p.parseConfig=function(e,t){if(e){var i=e.resources;if(i)for(var r=i.length,s=0;r>s;s++){var n=i[s],a=n.url;a&&-1==a.indexOf("://")&&(n.url=t+a),this.addItemToKeyMap(n)}var o=e.groups;if(o)for(r=o.length,s=0;r>s;s++){for(var u=o[s],l=[],h=u.keys.split(","),c=h.length,p=0;c>p;p++){var f=h[p].trim();n=this.keyMap[f],n&&-1==l.indexOf(n)&&l.push(n)}this.groupDic[u.name]=l}}},p.addSubkey=function(e,t){var i=this.keyMap[t];i&&!this.keyMap[e]&&(this.keyMap[e]=i)},p.addItemToKeyMap=function(e){if(this.keyMap[e.name]||(this.keyMap[e.name]=e),e.hasOwnProperty("subkeys")){var t=e.subkeys.split(",");e.subkeys=t;for(var i=t.length,r=0;i>r;r++){var s=t[r];null==this.keyMap[s]&&(this.keyMap[s]=e)}}},p.getName=function(e){var t=this.keyMap[e];return t?t.name:""},p.getType=function(e){var t=this.keyMap[e];return t?t.type:""},p.getRawResourceItem=function(e){return this.keyMap[e]},p.getResourceItem=function(e){var t=this.keyMap[e];return t?this.parseResourceItem(t):null},p.parseResourceItem=function(t){var i=new e.ResourceItem(t.name,t.url,t.type);return i.data=t,i},t}();e.ResourceConfig=t,lark.registerClass(t,"RES.ResourceConfig")}(RES||(RES={}));var RES;!function(e){var t=function(){function e(e,t,i){this.groupName="",this.data=null,this._loaded=!1,this.name=e,this.url=t,this.type=i}var t=__define,i=e;return p=i.prototype,t(p,"loaded",function(){return this.data?this.data.loaded:this._loaded},function(e){this.data&&(this.data.loaded=e),this._loaded=e}),p.toString=function(){return'[ResourceItem name="'+this.name+'" url="'+this.url+'" type="'+this.type+'"]'},e.TYPE_ANIMATION="animation",e.TYPE_XML="xml",e.TYPE_IMAGE="image",e.TYPE_BIN="bin",e.TYPE_TEXT="text",e.TYPE_JSON="json",e.TYPE_SHEET="sheet",e.TYPE_FONT="font",e.TYPE_SOUND="sound",e}();e.ResourceItem=t,lark.registerClass(t,"RES.ResourceItem")}(RES||(RES={}));var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);i.prototype=t.prototype,e.prototype=new i},RES;!function(e){var t=function(t){function i(e){t.call(this),this.thread=2,this.loadingCount=0,this.callBack=null,this.groupTotalDic={},this.numLoadedDic={},this.itemListDic={},this.groupErrorDic={},this.retryTimesDic={},this.maxRetryTimes=3,this.failedList=new Array,this.priorityQueue={},this.lazyLoadList=new Array,this.analyzerDic={},this.queueIndex=0,this.resInstance=e}__extends(i,t);var r=i;return p=r.prototype,p.isGroupInLoading=function(e){return void 0!==this.itemListDic[e]},p.loadGroup=function(t,i,r){if(void 0===r&&(r=0),!this.itemListDic[i]&&i){if(!t||0==t.length){lark.$warn(4001,i);var s=new e.ResourceEvent(e.ResourceEvent.GROUP_LOAD_ERROR);return s.groupName=i,void this.emit(s)}this.priorityQueue[r]?this.priorityQueue[r].push(i):this.priorityQueue[r]=[i],this.itemListDic[i]=t;for(var n=t.length,a=0;n>a;a++){var o=t[a];o.groupName=i}this.groupTotalDic[i]=t.length,this.numLoadedDic[i]=0,this.next()}},p.loadItem=function(e){this.lazyLoadList.push(e),e.groupName="",this.next()},p.next=function(){for(;this.loadingCount<this.thread;){var e=this.getOneResourceItem();if(!e)break;if(this.loadingCount++,e.loaded)this.onItemComplete(e);else{var t=this.resInstance.$getAnalyzerByType(e.type);t.loadFile(e,this.onItemComplete,this)}}},p.getOneResourceItem=function(){if(this.failedList.length>0)return this.failedList.shift();var e=Number.NEGATIVE_INFINITY;for(var t in this.priorityQueue)e=Math.max(e,t);var i=this.priorityQueue[e];if(!i||0==i.length)return 0==this.lazyLoadList.length?null:this.lazyLoadList.pop();for(var r,s=i.length,n=0;s>n&&(this.queueIndex>=s&&(this.queueIndex=0),r=this.itemListDic[i[this.queueIndex]],!(r.length>0));n++)this.queueIndex++;return 0==r.length?null:r.shift()},p.onItemComplete=function(t){this.loadingCount--;var i=t.groupName;if(!t.loaded){var r=this.retryTimesDic[t.name]||1;if(!(r>this.maxRetryTimes))return this.retryTimesDic[t.name]=r+1,this.failedList.push(t),void this.next();delete this.retryTimesDic[t.name],e.ResourceEvent.emitResourceEvent(this.resInstance,e.ResourceEvent.ITEM_LOAD_ERROR,i,t)}if(i){this.numLoadedDic[i]++;var s=this.numLoadedDic[i],n=this.groupTotalDic[i];if(t.loaded||(this.groupErrorDic[i]=!0),e.ResourceEvent.emitResourceEvent(this.resInstance,e.ResourceEvent.GROUP_PROGRESS,i,t,s,n),s==n){var a=this.groupErrorDic[i];this.removeGroupName(i),delete this.groupTotalDic[i],delete this.numLoadedDic[i],delete this.itemListDic[i],delete this.groupErrorDic[i],a?e.ResourceEvent.emitResourceEvent(this,e.ResourceEvent.GROUP_LOAD_ERROR,i):e.ResourceEvent.emitResourceEvent(this,e.ResourceEvent.GROUP_COMPLETE,i)}}else this.callBack.call(this.resInstance,t);this.next()},p.removeGroupName=function(e){for(var t in this.priorityQueue){for(var i=this.priorityQueue[t],r=i.length,s=0,n=!1,r=i.length,a=0;r>a;a++){var o=i[a];if(o==e){i.splice(s,1),n=!0;break}s++}if(n){0==i.length&&delete this.priorityQueue[t];break}}},i}(lark.EventEmitter);e.ResourceLoader=t,lark.registerClass(t,"RES.ResourceLoader")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(t,i,r){void 0===i&&(i=!1),void 0===r&&(r=!1),e.call(this,t,i,r),this.itemsLoaded=0,this.itemsTotal=0,this.groupName="",this.resItem=null}__extends(t,e);var i=t;return p=i.prototype,t.emitResourceEvent=function(e,i,r,s,n,a){void 0===r&&(r=""),void 0===s&&(s=null),void 0===n&&(n=0),void 0===a&&(a=0);var o=lark.Event.create(t,i,!1,!1);o.groupName=r,o.resItem=s,o.itemsLoaded=n,o.itemsTotal=a;var u=e.emit(o);return lark.Event.release(o),u},t.ITEM_LOAD_ERROR="itemLoadError",t.CONFIG_COMPLETE="configComplete",t.CONFIG_LOAD_ERROR="configLoadError",t.GROUP_PROGRESS="groupProgress",t.GROUP_COMPLETE="groupComplete",t.GROUP_LOAD_ERROR="groupLoadError",t}(lark.Event);e.ResourceEvent=t,lark.registerClass(t,"RES.ResourceEvent")}(RES||(RES={}));var RES;!function(e){var t=function(t){function i(){t.call(this),this.resourceConfig=null,this.resourceConfig=e.configInstance}__extends(i,t);var r=i;return p=r.prototype,p.addSubkey=function(e,t){this.resourceConfig.addSubkey(e,t)},p.loadFile=function(){},p.getRes=function(){},p.destroyRes=function(){return!1},i.getStringPrefix=function(e){if(!e)return"";var t=e.indexOf(".");return-1!=t?e.substring(0,t):""},i.getStringTail=function(e){if(!e)return"";var t=e.indexOf(".");return-1!=t?e.substring(t+1):""},i}(lark.HashObject);e.AnalyzerBase=t,lark.registerClass(t,"RES.AnalyzerBase")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.fileDic={},this.resItemDic=[],this.recycler=[]}__extends(t,e);var i=t;return p=i.prototype,p.loadFile=function(e,t,i){if(this.fileDic[e.name])return void t.call(i,e);var r=this.getLoader();this.resItemDic[r.$hashCode]={item:e,func:t,thisObject:i},r.load(e.url)},p.getLoader=function(){var e=this.recycler.pop();return e||(e=new lark.ImageLoader,e.on(lark.Event.COMPLETE,this.onLoadFinish,this),e.on(lark.Event.IO_ERROR,this.onLoadFinish,this)),e},p.onLoadFinish=function(e){var t=e.$target,i=this.resItemDic[t.$hashCode];delete this.resItemDic[t.$hashCode];var r=i.item,s=i.func;r.loaded=e.$type==lark.Event.COMPLETE,r.loaded&&this.analyzeData(r,t.data),this.recycler.push(t),s.call(i.thisObject,r)},p.analyzeData=function(e,t){var i=e.name;if(!this.fileDic[i]&&t){this.fileDic[i]=t;var r=e.data;if(r&&r.scale9grid){var s=r.scale9grid,n=s.split(",");t.scale9Grid=new lark.Rectangle(parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3]))}}},p.getRes=function(e){return this.fileDic[e]},p.hasRes=function(e){var t=this.getRes(e);return null!=t},p.destroyRes=function(e){return this.fileDic[e]?(delete this.fileDic[e],!0):!1},t}(e.AnalyzerBase);e.ImageAnalyzer=t,lark.registerClass(t,"RES.ImageAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.fileDic={},this.resItemDic=[],this.responseType=lark.HttpResponseType.ARRAY_BUFFER,this.recycler=[]}__extends(t,e);var i=t;return p=i.prototype,p.loadFile=function(e,t,i){if(this.fileDic[e.name])return void t.call(i,e);var r=this.getRequest();this.resItemDic[r.$hashCode]={item:e,func:t,thisObject:i},r.open(e.url),r.send()},p.getRequest=function(){var e=this.recycler.pop();return e||(e=new lark.HttpRequest,e.on(lark.Event.COMPLETE,this.onLoadFinish,this),e.on(lark.Event.IO_ERROR,this.onLoadFinish,this)),e.responseType=this.responseType,e},p.onLoadFinish=function(e){var t=e.target,i=this.resItemDic[t.$hashCode];delete this.resItemDic[t.$hashCode];var r=i.item,s=i.func;r.loaded=e.type==lark.Event.COMPLETE,r.loaded&&this.analyzeData(r,t.response),this.recycler.push(t),s.call(i.thisObject,r)},p.analyzeData=function(e,t){var i=e.name;!this.fileDic[i]&&t&&(this.fileDic[i]=t)},p.getRes=function(e){return this.fileDic[e]},p.hasRes=function(e){var t=this.getRes(e);return null!=t},p.destroyRes=function(e){return this.fileDic[e]?(delete this.fileDic[e],!0):!1},t}(e.AnalyzerBase);e.BinAnalyzer=t,lark.registerClass(t,"RES.BinAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.soundDic={},this.resItemDic=[]}__extends(t,e);var i=t;return p=i.prototype,p.loadFile=function(e,t,i){if(this.soundDic[e.name])return void t.call(i,e);var r=new lark.Sound;r.on(lark.Event.COMPLETE,this.onLoadFinish,this),r.on(lark.Event.IO_ERROR,this.onLoadFinish,this),this.resItemDic[r.$hashCode]={item:e,func:t,thisObject:i},r.load(e.url)},p.onLoadFinish=function(e){var t=e.$target;t.removeListener(lark.Event.COMPLETE,this.onLoadFinish,this),t.removeListener(lark.Event.IO_ERROR,this.onLoadFinish,this);var i=this.resItemDic[t.$hashCode];delete this.resItemDic[t.$hashCode];var r=i.item,s=i.func;r.loaded=e.$type==lark.Event.COMPLETE,r.loaded&&this.analyzeData(r,t),s.call(i.thisObject,r)},p.analyzeData=function(e,t){var i=e.name;!this.soundDic[i]&&t&&(this.soundDic[i]=t)},p.getRes=function(e){return this.soundDic[e]},p.hasRes=function(e){return!!this.getRes(e)},p.destroyRes=function(e){return this.soundDic[e]?(delete this.soundDic[e],!0):!1},t}(e.AnalyzerBase);e.SoundAnalyzer=t,lark.registerClass(t,"RES.SoundAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(t){function i(){t.call(this),this.sheetMap={},this.textureMap={},this.recyclerIamge=[],this.responseType=lark.HttpResponseType.TEXT}__extends(i,t);var r=i;return p=r.prototype,p.getRes=function(t){var i=this.fileDic[t];if(i||(i=this.textureMap[t]),!i){var r=e.AnalyzerBase.getStringPrefix(t);if(i=this.fileDic[r]){var s=e.AnalyzerBase.getStringTail(t);i=i[s]}}return i},p.onLoadFinish=function(e){var t=e.target,i=this.resItemDic[t.$hashCode];delete this.resItemDic[t.hashCode];var r=i.item,s=i.func;if(r.loaded=e.type==lark.Event.COMPLETE,r.loaded)if(t instanceof lark.HttpRequest){r.loaded=!1;var n=this.analyzeConfig(r,t.response);if(n)return this.loadImage(n,i),void this.recycler.push(t)}else this.analyzeBitmap(r,t.data);t instanceof lark.HttpRequest?this.recycler.push(t):this.recyclerIamge.push(t),s.call(i.thisObject,r)},p.analyzeConfig=function(e,t){var i,r=e.name,s="";try{var n=t;i=JSON.parse(n)}catch(a){lark.$warn(1017,e.url,t)}return i&&(this.sheetMap[r]=i,s=this.getRelativePath(e.url,i.file)),s},p.analyzeBitmap=function(e,t){var i=e.name;if(!this.fileDic[i]&&t){var r=this.sheetMap[i];delete this.sheetMap[i];var s=e.data&&e.data.subkeys?"":i,n=this.parseSpriteSheet(t,r,s);this.fileDic[i]=n}},p.getRelativePath=function(e,t){e=e.split("\\").join("/");var i=e.lastIndexOf("/");return e=-1!=i?e.substring(0,i+1)+t:t},p.parseSpriteSheet=function(e,t,i){var r=t.frames;if(!r)return null;var s={},n=this.textureMap;for(var a in r){var o=r[a],u=new lark.Texture(e,o.x,o.y,o.w,o.h,o.offX,o.offY,o.sourceW,o.sourceH);if(s[a]=u,o.scale9grid){var l=o.scale9grid,h=l.split(",");e.scale9Grid=new lark.Rectangle(parseInt(h[0]),parseInt(h[1]),parseInt(h[2]),parseInt(h[3]))}null==n[a]&&(n[a]=u,i&&this.addSubkey(a,i))}return s},p.destroyRes=function(e){var t=this.fileDic[e];if(t){delete this.fileDic[e];for(var i in t)this.textureMap[i]&&delete this.textureMap[i];return!0}return!1},p.loadImage=function(e,t){var i=this.getImageLoader();this.resItemDic[i.hashCode]=t,i.load(e)},p.getImageLoader=function(){var e=this.recyclerIamge.pop();return e||(e=new lark.ImageLoader,e.on(lark.Event.COMPLETE,this.onLoadFinish,this),e.on(lark.Event.IO_ERROR,this.onLoadFinish,this)),e},i}(e.BinAnalyzer);e.SheetAnalyzer=t,lark.registerClass(t,"RES.SheetAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.responseType=lark.HttpResponseType.TEXT}__extends(t,e);var i=t;return p=i.prototype,p.analyzeData=function(e,t){var i=e.name;if(!this.fileDic[i]&&t)try{var r=t;this.fileDic[i]=JSON.parse(r)}catch(s){}},t}(e.BinAnalyzer);e.JsonAnalyzer=t,lark.registerClass(t,"RES.JsonAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.responseType=lark.HttpResponseType.TEXT}__extends(t,e);var i=t;return p=i.prototype,p.analyzeData=function(e,t){var i=e.name;if(!this.fileDic[i]&&t)try{var r=t,s=lark.XML.parse(r);this.fileDic[i]=s}catch(n){}},t}(e.BinAnalyzer);e.XMLAnalyzer=t,lark.registerClass(t,"RES.XMLAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.sheetMap={},this.recyclerIamge=[],this.responseType=lark.HttpResponseType.TEXT}__extends(t,e);var i=t;return p=i.prototype,p.onLoadFinish=function(e){var t=e.target,i=this.resItemDic[t.$hashCode];delete this.resItemDic[t.hashCode];var r=i.item,s=i.func;if(r.loaded=e.type==lark.Event.COMPLETE,r.loaded)if(t instanceof lark.HttpRequest){r.loaded=!1;var n=this.analyzeConfig(r,t.response);if(n)return this.loadImage(n,i),void this.recycler.push(t)}else this.analyzeBitmap(r,t.data);t instanceof lark.HttpRequest?this.recycler.push(t):this.recyclerIamge.push(t),s.call(i.thisObject,r)},p.analyzeConfig=function(e,t){var i,r=e.name,s="";try{var n=t;i=JSON.parse(n)}catch(a){lark.$warn(1017,e.url,t)}if(i)if(this.sheetMap[r]=i,i.file)s=this.getRelativePath(e.url,i.file);else{var o=e.url.split("?"),u=o[0].split("/");u[u.length-1]=u[u.length-1].split(".")[0]+".png",s="";for(var l=0;l<u.length;l++)s+=u[l]+(l<u.length-1?"/":"");2==o.length&&(s+=o[2])}return s},p.analyzeBitmap=function(e,t){var i=e.name;if(!this.fileDic[i]&&t){var r=this.sheetMap[i];delete this.sheetMap[i];var s=e.data&&e.data.subkeys?"":i,n=this.parseAnimation(t,r,s);this.fileDic[i]=n}},p.getRelativePath=function(e,t){e=e.split("\\").join("/");var i=e.lastIndexOf("/");return e=-1!=i?e.substring(0,i+1)+t:t},p.parseAnimation=function(e,t){for(var i,r=Object.keys(t.mc),s=t.mc[r[0]].frames,n=s.length,a=[],o=0;n>o;o++)i=t.res[s[o].res],a[o]=new lark.Texture(e,i.x,i.y,i.w,i.h,s[o].x,s[o].y,s[o].sourceW,s[o].sourceH);return a},p.destroyRes=function(e){var t=this.fileDic[e];return t?(delete this.fileDic[e],!0):!1},p.loadImage=function(e,t){var i=this.getImageLoader();this.resItemDic[i.hashCode]=t,i.load(e)},p.getImageLoader=function(){var e=this.recyclerIamge.pop();return e||(e=new lark.ImageLoader,e.on(lark.Event.COMPLETE,this.onLoadFinish,this),e.on(lark.Event.IO_ERROR,this.onLoadFinish,this)),e},t}(e.BinAnalyzer);e.AnimationAnalyzer=t,lark.registerClass(t,"RES.AnimationAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){e.call(this),this.responseType=lark.HttpResponseType.TEXT}__extends(t,e);var i=t;return p=i.prototype,t}(e.BinAnalyzer);e.TextAnalyzer=t,lark.registerClass(t,"RES.TextAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=(e.JsonAnalyzer,e.BinAnalyzer,e.SoundAnalyzer,e.TextAnalyzer,e.XMLAnalyzer,e.AnimationAnalyzer,function(t){function i(){t.call(this),this.analyzerMap={},this.analyzerClassMap={},this.configItemList=[],this.callLaterFlag=!1,this.configComplete=!1,this.loadedGroups=[],this.groupNameList=[],this.asyncDic={},this.init()}__extends(i,t);var r=i;return p=r.prototype,p.registerAnalzer=function(e,t){this.analyzerClassMap[e]=t},p.$getAnalyzerByType=function(e){var t=this.analyzerMap[e];if(!t){var i=this.analyzerClassMap[e];if(!i)return null;t=this.analyzerMap[e]=new i}return t},p.init=function(){var t=this.analyzerClassMap;t[e.ResourceItem.TYPE_ANIMATION]=e.AnimationAnalyzer,t[e.ResourceItem.TYPE_BIN]=e.BinAnalyzer,t[e.ResourceItem.TYPE_IMAGE]=e.ImageAnalyzer,t[e.ResourceItem.TYPE_TEXT]=e.TextAnalyzer,t[e.ResourceItem.TYPE_JSON]=e.JsonAnalyzer,t[e.ResourceItem.TYPE_SHEET]=e.SheetAnalyzer,t[e.ResourceItem.TYPE_SOUND]=e.SoundAnalyzer,t[e.ResourceItem.TYPE_XML]=e.XMLAnalyzer,this.resConfig=new e.ResourceConfig,this.resLoader=new e.ResourceLoader(this),this.resLoader.callBack=this.onResourceItemComp,this.resLoader.on(e.ResourceEvent.GROUP_COMPLETE,this.onGroupComp,this),this.resLoader.on(e.ResourceEvent.GROUP_LOAD_ERROR,this.onGroupError,this)},p.loadConfig=function(e,t,i){void 0===i&&(i="json");var r={url:e,resourceRoot:t,type:i};if(this.configItemList.push(r),!this.callLaterFlag){var s=this;setTimeout(function(){s.startLoadConfig()},0),this.callLaterFlag=!0}},p.startLoadConfig=function(){this.callLaterFlag=!1;var t=this.configItemList;this.configItemList=[],this.loadingConfigList=t;for(var r=t.length,s=[],n=0;r>n;n++){var a=t[n],o=new e.ResourceItem(a.url,a.url,a.type);s.push(o)}this.resLoader.loadGroup(s,i.GROUP_CONFIG,Number.MAX_VALUE)},p.isGroupLoaded=function(e){return-1!=this.loadedGroups.indexOf(e)},p.getGroupByName=function(e){return this.resConfig.getGroupByName(e)},p.loadGroup=function(t,i){if(void 0===i&&(i=0),-1!=this.loadedGroups.indexOf(t))return void e.ResourceEvent.emitResourceEvent(this,e.ResourceEvent.GROUP_COMPLETE,t);if(!this.resLoader.isGroupInLoading(t))if(this.configComplete){var r=this.resConfig.getGroupByName(t);this.resLoader.loadGroup(r,t,i)}else this.groupNameList.push({name:t,priority:i})},p.createGroup=function(e,t,i){if(void 0===i&&(i=!1),i){var r=this.loadedGroups.indexOf(e);-1!=r&&this.loadedGroups.splice(r,1)}return this.resConfig.createGroup(e,t,i)},p.onGroupComp=function(t){if(t.groupName==i.GROUP_CONFIG){for(var r=this.loadingConfigList.length,s=0;r>s;s++){var n=this.loadingConfigList[s],a=this.$getAnalyzerByType(n.type),o=a.getRes(n.url);a.destroyRes(n.url),this.resConfig.parseConfig(o,n.resourceRoot)}this.configComplete=!0,this.loadingConfigList=null,e.ResourceEvent.emitResourceEvent(this,e.ResourceEvent.CONFIG_COMPLETE),this.loadDelayGroups()}else this.loadedGroups.push(t.groupName),this.emit(t)},p.loadDelayGroups=function(){var e=this.groupNameList;this.groupNameList=[];for(var t=e.length,i=0;t>i;i++){var r=e[i];this.loadGroup(r.name,r.priority)}},p.onGroupError=function(t){t.groupName==i.GROUP_CONFIG?(this.loadingConfigList=null,e.ResourceEvent.emitResourceEvent(this,e.ResourceEvent.CONFIG_LOAD_ERROR)):this.emit(t)},p.hasRes=function(t){var i=this.resConfig.getType(t);if(""==i){var r=e.AnalyzerBase.getStringPrefix(t);if(i=this.resConfig.getType(r),""==i)return!1}return!0},p.parseConfig=function(e,t){this.resConfig.parseConfig(e,t),this.configComplete||this.loadingConfigList||(this.configComplete=!0,this.loadDelayGroups())},p.getRes=function(t){var i=this.resConfig.getType(t);if(""==i){var r=e.AnalyzerBase.getStringPrefix(t);if(i=this.resConfig.getType(r),""==i)return null}var s=this.$getAnalyzerByType(i);return s.getRes(t)},p.getResAsync=function(t,i,r){var s=this.resConfig.getType(t),n=this.resConfig.getName(t);if(""==s&&(n=e.AnalyzerBase.getStringPrefix(t),s=this.resConfig.getType(n),""==s))return void setTimeout(function(){i.call(r)},0);var a=this.$getAnalyzerByType(s),o=a.getRes(t);if(o)return void setTimeout(function(){i.call(r,o,t)},0);var u={key:t,compFunc:i,thisObject:r};if(this.asyncDic[n])this.asyncDic[n].push(u);else{this.asyncDic[n]=[u];var l=this.resConfig.getResourceItem(n);this.resLoader.loadItem(l)}},p.getResByUrl=function(t,i,r,s){if(void 0===s&&(s=""),!t)return void setTimeout(function(){i.call(r)},0);s||(s=this.getTypeByUrl(t));var n=this.$getAnalyzerByType(s),a=t,o=n.getRes(a);if(o)return void setTimeout(function(){i.call(r,o,t)},0);var u={key:a,compFunc:i,thisObject:r};if(this.asyncDic[a])this.asyncDic[a].push(u);else{this.asyncDic[a]=[u];var l=new e.ResourceItem(a,t,s);this.resLoader.loadItem(l)}},p.getTypeByUrl=function(t){var i=t.substr(t.lastIndexOf(".")+1);i&&(i=i.toLowerCase());var r;switch(i){case e.ResourceItem.TYPE_XML:case e.ResourceItem.TYPE_JSON:case e.ResourceItem.TYPE_SHEET:r=i;break;case"png":case"jpg":case"gif":case"jpeg":case"bmp":r=e.ResourceItem.TYPE_IMAGE;break;case"fnt":r=e.ResourceItem.TYPE_FONT;break;case"txt":r=e.ResourceItem.TYPE_TEXT;break;case"mp3":case"ogg":case"mpeg":case"wav":case"m4a":case"mp4":case"aiff":case"wma":case"mid":r=e.ResourceItem.TYPE_SOUND;break;default:r=e.ResourceItem.TYPE_BIN}return r},p.onResourceItemComp=function(e){var t=this.asyncDic[e.name];delete this.asyncDic[e.name];for(var i=this.$getAnalyzerByType(e.type),r=t.length,s=0;r>s;s++){var n=t[s],a=i.getRes(n.key);n.compFunc.call(n.thisObject,a,n.key)}},p.destroyRes=function(e,t){void 0===t&&(t=!0);var i=this.resConfig.getRawGroupByName(e);if(i&&i.length>0){var r=this.loadedGroups.indexOf(e);-1!=r&&this.loadedGroups.splice(r,1);for(var s=i.length,n=0;s>n;n++){var a=i[n];if(!t&&this.isResInLoadedGroup(a.name));else{a.loaded=!1;var o=this.$getAnalyzerByType(a.type);o.destroyRes(a.name),this.removeLoadedGroupsByItemName(a.name)}}return!0}var u=this.resConfig.getType(e);if(""==u)return!1;a=this.resConfig.getRawResourceItem(e),a.loaded=!1,o=this.$getAnalyzerByType(u);var l=o.destroyRes(e);return this.removeLoadedGroupsByItemName(a.name),l},p.removeLoadedGroupsByItemName=function(e){for(var t=this.loadedGroups,i=t.length,r=0;i>r;r++)for(var s=this.resConfig.getRawGroupByName(t[r]),n=s.length,a=0;n>a;a++){var o=s[a];if(o.name==e){t.splice(r,1),r--,i=t.length;break}}},p.isResInLoadedGroup=function(e){for(var t=this.loadedGroups,i=t.length,r=0;i>r;r++)for(var s=this.resConfig.getRawGroupByName(t[r]),n=s.length,a=0;n>a;a++){var o=s[a];if(o.name==e)return!0}return!1},p.setMaxLoadingThread=function(e){1>e&&(e=1),this.resLoader.thread=e},p.setMaxRetryTimes=function(e){e=Math.max(e,0),this.resLoader.maxRetryTimes=e},i.GROUP_CONFIG="RES__CONFIG",i}(lark.EventEmitter));e.Resource=t,lark.registerClass(t,"RES.Resource")}(RES||(RES={}));var RES;!function(e){function t(e,t,i){void 0===t&&(t=""),void 0===i&&(i="json"),y.loadConfig(e,t,i)}function i(e,t){void 0===t&&(t=0),y.loadGroup(e,t)}function r(e){return y.isGroupLoaded(e)}function s(e){return y.getGroupByName(e)}function n(e,t,i){return void 0===i&&(i=!1),y.createGroup(e,t,i)}function a(e){return y.hasRes(e)}function o(e,t){void 0===t&&(t=""),y.parseConfig(e,t)}function u(e){return y.getRes(e)}function l(e,t,i){y.getResAsync(e,t,i)}function h(e,t,i,r){void 0===r&&(r=""),y.getResByUrl(e,t,i,r)}function c(e,t){return y.destroyRes(e,t)}function p(e){y.setMaxLoadingThread(e)}function f(e){y.setMaxRetryTimes(e)}function d(e,t,i,r,s){void 0===r&&(r=!1),void 0===s&&(s=0),y.on(e,t,i,r,s)}function g(e,t,i,r,s){void 0===r&&(r=!1),void 0===s&&(s=0),y.once(e,t,i,r,s)}function v(e,t,i,r){void 0===r&&(r=!1),y.removeListener(e,t,i,r)}var y=new e.Resource;e.loadConfig=t,e.loadGroup=i,e.isGroupLoaded=r,e.getGroupByName=s,e.createGroup=n,e.hasRes=a,e.parseConfig=o,e.getRes=u,e.getResAsync=l,e.getResByUrl=h,e.destroyRes=c,e.setMaxLoadingThread=p,e.setMaxRetryTimes=f,e.on=d,e.once=g,e.removeListener=v}(RES||(RES={}));